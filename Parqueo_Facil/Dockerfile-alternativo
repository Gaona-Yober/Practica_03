# Etapa de construcci칩n con Java 21
FROM maven:3.9.6-eclipse-temurin-21 AS build
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# Etapa de despliegue con Payara
FROM payara/server-full:6.2024.1

# Definir variables de entorno para Payara
ENV PAYARA_PATH=/opt/payara
ENV PAYARA_DOMAIN=domain1

# Cambiar a root temporalmente para configuraci칩n
USER root

# 1. Crear archivo de contrase침as
RUN mkdir -p /opt/payara/config && \
    echo 'AS_ADMIN_PASSWORD=admin\n\
AS_ADMIN_SSHPASSWORD=admin\n\
AS_ADMIN_USERPASSWORD=admin' > /opt/payara/config/pwdfile && \
    chown payara:payara /opt/payara/config/pwdfile && \
    chmod 600 /opt/payara/config/pwdfile

# 2. Crear directorio lib si no existe e instalar driver MySQL
RUN mkdir -p ${PAYARA_PATH}/glassfish/lib && \
    microdnf install -y wget && \
    wget https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/8.0.33/mysql-connector-j-8.0.33.jar \
    -O ${PAYARA_PATH}/glassfish/lib/mysql-connector-j.jar && \
    microdnf remove -y wget && \
    microdnf clean all && \
    chown -R payara:payara ${PAYARA_PATH}/glassfish/lib

# Volver al usuario payara
USER payara

# 3. Configurar el datasource al iniciar
COPY --chown=payara:payara configure-payara.sh /opt/payara/
RUN chmod +x /opt/payara/configure-payara.sh

# Copiar la aplicaci칩n
COPY --from=build --chown=payara:payara /app/target/Parqueo_Facil.war $DEPLOY_DIR

# Puerto expuesto
EXPOSE 8080 4848

# Comando de inicio personalizado
CMD ["/opt/payara/configure-payara.sh"]